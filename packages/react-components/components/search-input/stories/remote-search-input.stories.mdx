import { Anchor, Meta, Preview, Story } from "@storybook/addon-docs/blocks";
import { ControlledRemoteSearchInput } from "./components";
import { GithubLink, PropsTabs, PackagesInstallation } from "@docs-blocks";
import { LAURIE_VALUE } from "./data";
import { RemoteSearchInput, searchInputResult, useDefaultResultsFetcher } from "@orbit-ui/react-search-input/src";
import { boolean, number, text, withKnobs } from "@storybook/addon-knobs";
import { logValueChanged } from "./utils";
import { paramsBuilder, INSTALLATION_PAGE, createComponentSection } from "@utils";

<Meta
    title={createComponentSection("Search Input/remote")}
    parameters={paramsBuilder()
        .width("80%")
        .build()}
/>

<GithubLink filePath="/packages/react-components/components/search-input/src" />

<Anchor storyId="components-search-input-remote--default-story" />

# Remote Search Input

A remote search input allows a user to query for results from a remote data source.

## Installation

<details><summary >install the packages</summary>

Install from <a href={INSTALLATION_PAGE}>the React bundle</a> or as a standalone component:

<PackagesInstallation packageName="search-input" />

</details>

<details><summary >then import what you need</summary>

```javascript
import {
    RemoteSearchInput,
    searchInputResult,
    useDefaultResultsFetcher
} from "@orbit-ui/react-search-input" | "@orbit-ui/react-components";
```
</details>

## Props

<PropsTabs
    componentsDefinitions={[
        { displayName: "RemoteSearchInput", component: RemoteSearchInput }
    ]}
/>

## Remote API throttling

For demo purpose, we use [GeoDB cities free API](https://rapidapi.com/wirefreethought/api/geodb-cities) through [Rapid API](https://rapidapi.com/) which is throttled at 1 request / sec and have a daily quota of 1000 requests.

*Please, dont abuse and be patient!*

## Usage

### Fetching results

A remote search input component requires a results fetcher. It can be specified with the `onFetchResults` property.

The easiest way to fetch data is by using the `useDefaultResultsFetcher(url, queryParameter?, options?)` function:

```jsx
<RemoteSearchInput
    onFetchResults={useDefaultResultsFetcher("https://wft-geo-db.p.rapidapi.com/v1/geo/countries?limit=5", "namePrefix")}
/>
```

<details><summary >or you can write a custom one</summary>

A custom results fetcher must returned a `Promise` that resolved to an array of data.

```jsx
function fetchResults(event, query) {
    return new Promise((resolve, reject) => {
        fetch(`https://wft-geo-db.p.rapidapi.com/v1/geo/countries?limit=5&namePrefix=${query}`)
            .then(response => {
                resolve(response.json());
            })
            .catch(error => {
                reject(error);
            })
    });
}

<RemoteSearchInput
    onFetchResults={fetchResults}
/>
```
</details>

### searchInputResult

A remote search input component requires a set of results to display. Those results are obtained by transforming the remote data to `SearchInputResult` by the `onResults` handler.

To create a result, use the `searchInputResult(id, text, obj?)` function:

```jsx
<RemoteSearchInput
    onResults={response => {
        return response.data.map(x => searchInputResult(x.code, x.name));
    }}
/>
```

<details classNam="outline-0"><summary >specify optional data</summary>

An optional data `obj` can be specified to provide additional information to callbacks like `onValueChange`:

```jsx
<RemoteSearchInput
    onResults={response => {
        return response.data.map(x => searchInputResult(x.code, x.name, { backendId: x.backendId }));
    }}
/>
```
</details>

export const API_REQUEST_OPTIONS = {
    headers: {
        "x-rapidapi-host": "wft-geo-db.p.rapidapi.com",
		"x-rapidapi-key": "d699c01b23mshb9832bb0fd12929p128485jsn5a749c0b2741"
    }
};

### Default

A default remote search input.

<Preview>
    <Story name="default">
        <RemoteSearchInput
            onFetchResults={useDefaultResultsFetcher("https://wft-geo-db.p.rapidapi.com/v1/geo/countries?limit=5", "namePrefix", { requestOptions: API_REQUEST_OPTIONS })}
            onResults={response => {
                return response.data.map(x => searchInputResult(x.code, x.name));
            }}
            onValueChange={logValueChanged}
            placeholder="Type a country name"
        />
    </Story>
</Preview>

<Story
    name="knobs"
    decorators={[withKnobs]}
    parameters={paramsBuilder()
        .excludeFromDocs()
        .build()}
>
    <RemoteSearchInput
        onFetchResults={useDefaultResultsFetcher("https://wft-geo-db.p.rapidapi.com/v1/geo/countries?limit=5", "namePrefix", { requestOptions: API_REQUEST_OPTIONS })}
        onResults={response => {
            return response.data.map(x => searchInputResult(x.code, x.name));
        }}
        defaultValue={text("defaultValue")}
        debounceDelay={number("debounceDelay", RemoteSearchInput.defaultProps.debounceDelay)}
        loadingDelay={number("loadingDelay", RemoteSearchInput.defaultProps.loadingDelay)}
        minCharacters={number("minCharacters", RemoteSearchInput.defaultProps.minCharacters)}
        noResultsMessage={text("noResultsMessage")}
        placeholder={text("placeholder", "Type a country name")}
        disabled={boolean("disabled", false)}
        onValueChange={logValueChanged}
    />
</Story>

### Selected value

A remote search input can have a default value.

<Preview>
    <Story name="selected value">
        <RemoteSearchInput
            onFetchResults={useDefaultResultsFetcher("https://wft-geo-db.p.rapidapi.com/v1/geo/countries?limit=5", "namePrefix", { requestOptions: API_REQUEST_OPTIONS })}
            onResults={response => {
                return response.data.map(x => searchInputResult(x.code, x.name));
            }}
            defaultValue="Canada"
            onValueChange={logValueChanged}
            placeholder="Type a country name"
        />
    </Story>
</Preview>

### Clear on select

A remote search input results box can close when a result is selected.

<Preview>
    <Story name="clear on select">
        <RemoteSearchInput
            onFetchResults={useDefaultResultsFetcher("https://wft-geo-db.p.rapidapi.com/v1/geo/countries?limit=5", "namePrefix", { requestOptions: API_REQUEST_OPTIONS })}
            onResults={response => {
                return response.data.map(x => searchInputResult(x.code, x.name));
            }}
            clearOnSelect
            onValueChange={logValueChanged}
            placeholder="Type a country name"
        />
    </Story>
</Preview>

<Story
    name="autofocus"
    parameters={paramsBuilder()
        .excludeFromDocs()
        .build()}
>
    <RemoteSearchInput
        onFetchResults={useDefaultResultsFetcher("https://wft-geo-db.p.rapidapi.com/v1/geo/countries?limit=5", "namePrefix", { requestOptions: API_REQUEST_OPTIONS })}
        onResults={response => {
            return response.data.map(x => searchInputResult(x.code, x.name));
        }}
        autofocus
        onValueChange={logValueChanged}
        placeholder="Type a country name"
    />
</Story>

### Disabled

A remote search input can be disabled.

<Preview>
    <Story name="disabled">
        <RemoteSearchInput
            onFetchResults={useDefaultResultsFetcher("https://wft-geo-db.p.rapidapi.com/v1/geo/countries?limit=5", "namePrefix", { requestOptions: API_REQUEST_OPTIONS })}
            onResults={response => {
                return response.data.map(x => searchInputResult(x.code, x.name));
            }}
            disabled
            onValueChange={logValueChanged}
            placeholder="Type a country name"
        />
    </Story>
</Preview>

<Story
    name="dont close on blur"
    parameters={paramsBuilder()
        .excludeFromDocs()
        .build()}
    >
    <RemoteSearchInput
        onFetchResults={useDefaultResultsFetcher("https://wft-geo-db.p.rapidapi.com/v1/geo/countries?limit=5", "namePrefix", { requestOptions: API_REQUEST_OPTIONS })}
        onResults={response => {
            return response.data.map(x => searchInputResult(x.code, x.name));
        }}
        closeOnBlur={false}
        closeOnOutsideClick
        onValueChange={logValueChanged}
        placeholder="Type a country name"
    />
</Story>

<Story
    name="failing fetch"
    parameters={paramsBuilder()
        .excludeFromDocs()
        .build()}
    >
    <RemoteSearchInput
        onFetchResults={() => Promise.reject()}
        onValueChange={logValueChanged}
        placeholder="Type a country name"
    />
</Story>

### Controlled

A remote search input can handle `value` and `open` state in controlled mode.

<Preview>
    <Story name="controlled">
        <ControlledRemoteSearchInput
            onFetchResults={useDefaultResultsFetcher("https://wft-geo-db.p.rapidapi.com/v1/geo/countries?limit=5", "namePrefix", { requestOptions: API_REQUEST_OPTIONS })}
            onResults={response => {
                return response.data.map(x => searchInputResult(x.code, x.name));
            }}
            onValueChange={logValueChanged}
            placeholder="Type a country name"
        />
    </Story>
</Preview>




